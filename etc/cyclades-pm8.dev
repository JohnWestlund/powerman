#
# cyclades-pm8.dev,v 1.1 2003/08/05 22:36:28 garlick Exp
# /chaos/cvs/powerman/etc/cyclades-pm8.dev,v
#
# Cyclades PM8i s/w v. 1.0.9a
#
specification "pm8" {
	timeout 	10

	plug name { "1" "2" "3" "4" "5" "6" "7" "8" }

# Unfortunately it seems there is a non-configurable login timeout.
# Typing exit and two carriage returns will get you to a Username: prompt 
# if you are at pm> or Username: to begin with.  So the login script is 
# really a logoff script, and every command is wrapped in login/logoff.
# XXX powerman should make this easier!

	script login {
		send "exit\r\r"
		expect "Username:"
	}
	script status_all {
		send "admin\r"
		expect "Password:"
		send "pm8\r"
		expect "pm>"

		send "status 1-8\r"
		foreachplug {
			expect " ([1-8]+)\t\t\t\tUnlocked (ON|OFF)"
			setplugstate $1 $2 on="ON" off="OFF"
		}
		expect "pm>"

		send "exit\r"
		expect "Username:"
	}
	script on {
		send "admin\r"
		expect "Password:"
		send "pm8\r"
		expect "pm>"

		send "on %s\r"
		expect "Outlet turned on.\r\n"
		expect "pm>"

		send "exit\r"
		expect "Username:"
	}
	script on_all {
		send "admin\r"
		expect "Password:"
		send "pm8\r"
		expect "pm>"

		send "on 1-8\r"
		foreachplug {
			expect "Outlet turned on.\r\n"
		}
		expect "pm>"

		send "exit\r"
		expect "Username:"
	}
	script off {
		send "admin\r"
		expect "Password:"
		send "pm8\r"
		expect "pm>"

		send "off %s\r"
		expect "Outlet turned off.\r\n"
		expect "pm>"

		send "exit\r"
		expect "Username:"
	}
	script off_all {
		send "admin\r"
		expect "Password:"
		send "pm8\r"
		expect "pm>"

		send "off 1-8\r"
		foreachplug {
			expect "Outlet turned off.\r\n"
		}
		expect "pm>"

		send "exit\r"
		expect "Username:"
	}
	script cycle {
		send "admin\r"
		expect "Password:"
		send "pm8\r"
		expect "pm>"

		send "off %s\r"
		expect "Outlet turned off.\r\n"
		expect "pm>"
		delay 2
		send "on %s\r"
		expect "Outlet turned on.\r\n"
		expect "pm>"

		send "exit\r"
		expect "Username:"
	}
	script cycle_all {
		send "admin\r"
		expect "Password:"
		send "pm8\r"
		expect "pm>"

		send "off 1-8\r"
		foreachplug {
			expect "Outlet turned off.\r\n"
		}
		expect "pm>"
		delay 2
		send "on 1-8\r"
		foreachplug {
			expect "Outlet turned on.\r\n"
		}
		expect "pm>"

		send "exit\r"
		expect "Username:"
	}
}
